# ----------------------------------------------------
# 最適化された MySQL 設定ファイル (my.cnf)
# 2コア8GB Webサービス向け
# ----------------------------------------------------
[mysqld]
# 1. 文字コード設定 (日本語・絵文字対応)
character-set-server = utf8mb4
collation-server = utf8mb4_0900_ai_ci # より高速な collate を推奨

# 2. パフォーマンス調整
lower_case_table_names = 1             # Linuxで大文字・小文字を区別しない
secure_file_priv = "/docker-entrypoint-initdb.d/csv"

# 接続数 (デフォルトの100は低すぎるため、システム要件に応じて大幅に増加)
# Nginxの worker_connections や GoアプリのDB接続プールと連携させる
max_connections = 5000 

# メモリ調整 (8GB環境向けに設定を最適化)

# クエリキャッシュは非推奨のため使用しない (MySQL 5.7/8.0以降では削除)
# query_cache_size = 0 

# InnoDBのバッファプールサイズ (物理メモリの70〜80%を推奨)
# 8GBの70%として5.6GB程度。ここでは 5G に設定
innodb_buffer_pool_size = 5G 

# ログファイルへの同期頻度 (トランザクションの永続性)
# 2 (推奨: 性能と安全性のバランス) または 0/1 (安全性/最速)
innodb_flush_log_at_trx_commit = 2 

# 一時テーブル (JOINやORDER BYで使用)
# 2コア8GB環境では 256M は許容範囲
tmp_table_size = 256M
max_heap_table_size = 256M

# ネットワークパケットサイズ
max_allowed_packet = 256M

# 3. 全文検索設定
# ngram_token_size は 5 では日本語としては長すぎるため、2 に戻すことを推奨
# (通常の日本語では2〜3が標準)
ngram_token_size = 2 

# 4. ログとスキーマ
performance_schema = OFF # 負荷が高い場合OFFでよい
slow_query_log = ON      # チューニングのためONを推奨
slow_query_log_file = /var/lib/mysql/slow.log
long_query_time = 1      # 1秒以上のクエリをログに出力
general_log = OFF        # 通常はOFF

# 5. その他
disable-log-bin # 本番環境ではレプリケーションのためにOFFにしないことを推奨

[mysqldump]
max_allowed_packet = 256m

[client]
default-character-set = utf8mb4
